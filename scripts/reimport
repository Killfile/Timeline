#!/usr/bin/env bash
set -euo pipefail

# Convenience wrapper: truncate tables, then restart the ingestion container.

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT_DIR"

"$ROOT_DIR/scripts/reset-db"

echo "Restarting wikipedia-ingestion service..."

# Compose 'restart' only touches the service container. If you've ever used
# `docker compose run wikipedia-ingestion ...`, those one-off containers can
# stick around (often "Exited"/idle) and cause confusion.
#
# To make reimport deterministic, we:
#  - stop/remove the service container
#  - remove any stray containers created from the ingestion image
#  - start exactly one fresh service container

docker compose stop wikipedia-ingestion >/dev/null 2>&1 || true
docker compose rm -f wikipedia-ingestion >/dev/null 2>&1 || true

# Remove orphaned one-off containers for this service (compose-run creates
# names like <proj>-wikipedia-ingestion-run-<id>).
docker rm -f $(docker ps -aq --filter "name=wikipedia-ingestion") >/dev/null 2>&1 || true

docker compose up -d --no-deps --force-recreate wikipedia-ingestion

echo "Done. Tail logs with: docker compose logs -f wikipedia-ingestion"