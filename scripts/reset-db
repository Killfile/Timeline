#!/usr/bin/env bash
set -euo pipefail

# Truncate timeline tables but keep the Postgres volume and schema.
# Safer than deleting the whole volume.

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT_DIR"

COMPOSE="docker compose"

db_container_id="$($COMPOSE ps -q database)"
if [[ -z "${db_container_id}" ]]; then
  echo "Database container isn't running. Start the stack first." >&2
  exit 1
fi

echo "Truncating tables in Postgres..."
$COMPOSE exec -T database psql -U "${POSTGRES_USER:-timeline_user}" -d "${POSTGRES_DB:-timeline_history}" <<'SQL'
BEGIN;
TRUNCATE TABLE event_date_extraction_debug RESTART IDENTITY;
TRUNCATE TABLE historical_events RESTART IDENTITY CASCADE;
COMMIT;
SQL

echo "Applying database migrations (idempotent)..."

shopt -s nullglob
MIGRATIONS=("$ROOT_DIR"/database/migrations/*.sql)
if (( ${#MIGRATIONS[@]} )); then
  for f in "${MIGRATIONS[@]}"; do
    echo "  - $(basename "$f")"
    $COMPOSE exec -T database psql -v ON_ERROR_STOP=1 -U "${POSTGRES_USER:-timeline_user}" -d "${POSTGRES_DB:-timeline_history}" < "$f"
  done
else
  echo "  (no migrations found)"
fi

echo "Done."